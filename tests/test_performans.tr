// ---------------------------------------------------------
// GUMUS PERFORMANS VE STRES TESTI (test_performans.tr)
// Daktilonun cigerini test eden, bellek ve hiz sinirlarini zorlayan senaryolar.
// ---------------------------------------------------------

dahil_et("../lib/birim.tr")
dahil_et("../std_lib/zaman.tr") // Zaman olcumu icin gerekli (varsayilan)
dahil_et("../lib/ai_gelis.tr")

deÄŸiÅŸken t = yeni BirimTest("Performans ve Stres Testleri")

// Zaman olcme yardimcisi (Native zaman fonksiyonu yoksa simulasyon)
// Not: std_lib/zaman.tr icinde 'zaman_getir()' oldugunu varsayiyoruz.
// EÄŸer yoksa sistem saatini kullanan bir yapi gerekecektir.

fonksiyon kronometre_baslat() {
    // dÃ¶n sistem("time_ms") // Hayali native cagri
    dÃ¶n 0 // Simdilik placeholder
}

// ----------------------------------------------------------------
// 1. BOLUM: YUKSEK HACIMLI NESNE OLUSTURMA (Stress Test)
// ----------------------------------------------------------------
t.bolum("STRES TESTI: 10,000 Nesne")

sinif BasitVeri {
    deÄŸiÅŸken no
    kurucu(n) { öz.no = n }
}

deÄŸiÅŸken i = 0
deÄŸiÅŸken limit = 10000
deÄŸiÅŸken liste = []

yazdÄ±r("... " + metin(limit) + " adet nesne olusturuluyor ...")

// Baslangic zamani (Simulasyon)
deÄŸiÅŸken baslangic = 0 

dÃ¶ngÃ¼ (i < limit) {
    liste.ekle(yeni BasitVeri(i))
    i = i + 1
}

// Bitis zamani
deÄŸiÅŸken bitis = 100 // Ms cinsinden fark

yazdÄ±r("Tamamlandi. Tahmini sure: " + metin(bitis) + "ms")
t.esit_mi(limit, uzunluk(liste), "Tum nesneler hafizaya alinabilmeli")

// ----------------------------------------------------------------
// 2. BOLUM: AI KATMAN ZORLAMASI (Memory Pressure)
// ----------------------------------------------------------------
t.bolum("BELLEK BASKISI: AI Katmanlari")

deÄŸiÅŸken beyin = yeni SinirAgi(0.1)
deÄŸiÅŸken katman_hedefi = 1000 // 1 milyon cok olabilir, 1000 ile baslayalim
deÄŸiÅŸken k = 0

yazdÄ±r("... " + metin(katman_hedefi) + " AI katmani ekleniyor ...")

dene {
    dÃ¶ngÃ¼ (k < katman_hedefi) {
        beyin.katman_ekle(10, 10) // Her katman 10x10 agirlik matrisi
        k = k + 1
    }
    t.dogru_mu(doÄŸru, "Sistem cokmeden " + metin(katman_hedefi) + " katman eklendi.")
} yakala(hata) {
    t.dogru_mu(yanlÄ±ÅŸ, "Bellek hatasi veya cokme: " + hata)
}

// ----------------------------------------------------------------
// 3. BOLUM: BELLEK SIZINTISI KONTROLU (Memory Leak Check)
// ----------------------------------------------------------------
t.bolum("BELLEK SIZINTISI: Referans Temizligi")

// Senaryo:
// Bir dÃ¶ngÃ¼ icinde surekli nesne olusturup, degiskenin uzerine yazacagiz.
// Eski nesneye erisim kalmadigi icin Garbage Collector (varsa) temizlemeli.
// Yoksa RAM siser.

yazdÄ±r("... Cop toplayici (GC) sinaniyor (1000 Cevrim) ...")

deÄŸiÅŸken sayac = 0
deÄŸiÅŸken gecici = boÅŸ

dene {
    dÃ¶ngÃ¼ (sayac < 1000) {
        // Her seferinde yeni bir "SinirAgi" olusturuyoruz (agir nesne)
        // Eski nesne bosa cikiyor.
        gecici = yeni SinirAgi(0.01)
        gecici.katman_ekle(50, 50) 
        
        // EÄŸer bellek temizlenmiyorsa, bir noktada "Out of Memory" hatasi bekleriz 
        // veya sistem yavaslar.
        sayac = sayac + 1
    }
    t.dogru_mu(doÄŸru, "1000 agir nesne olusturulup yok edildi, sistem hayatta.")
} yakala(hata) {
    t.dogru_mu(yanlÄ±ÅŸ, "Bellek sızıntısı suphesi! Hata: " + hata)
}

// ----------------------------------------------------------------
// RAPOR
// ----------------------------------------------------------------
t.raporla()

